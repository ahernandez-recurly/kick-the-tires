##########################################################################
# DO NOT MODIFY
#
# THIS FILE SHOULD LIVE IN .github/workflows/terrateam.yml
#
# Looking for the Terrateam configuration file? .terrateam/config.yml.
#
# See https://terrateam.io/docs
##########################################################################
 name: 'Terrateam Workflow'
 on:
   workflow_dispatch:
     inputs:
       # The work-token and api-base-url are automatically passed in by the Terrateam server
       work-token:
         description: 'Work Token'
         required: true
       api-base-url:
         description: 'API Base URL'
       environment:
         description: 'Environment in which to run the action'
         type: environment
 jobs:
   terrateam:
     permissions: # Required to pass credentials to the Terrateam action
       id-token: write
       contents: read
     runs-on: ubuntu-latest
     timeout-minutes: 1440
     name: Terrateam Action
     environment: '${{ github.event.inputs.environment }}'
     steps:
       - uses: actions/checkout@v4
       - name: Add custom CA certificate
         run: |
          echo "$CUSTOM_CA_CERT" > custom-ca.pem
         env:
          CUSTOM_CA_BUNDLE_TERRATEAM: ${{ secrets.CUSTOM_CA_CERT }}
       - name: install opentofu
         run: |
           curl --proto '=https' --tlsv1.2 -fsSL https://get.opentofu.org/install-opentofu.sh -o install-opentofu.sh
           chmod +x install-opentofu.sh
           ./install-opentofu.sh --install-method deb
           which tofu
           tofu --version
       - name: install terragrunt
         run: |
           wget https://github.com/gruntwork-io/terragrunt/releases/download/v0.57.13/terragrunt_linux_amd64 -O terragrunt
           chmod u+x terragrunt
           mv terragrunt /usr/local/bin/terragrunt
           terragrunt --version'
       - name: install direnv
         run: |
           sudo apt-get update
           sudo apt-get install direnv
           echo 'eval "$(direnv hook bash)"' >> ~/.bashrc
           source ~/.bashrc
       - name: direnv to use opentofu for terragrunt
         run: |
           pwd
           ls -l
           cd kick-the-tires
           pwd
           touch .envrc
           TOFU_PATH=$(which tofu)
           echo "TERRAGRUNT_TFPATH=$TOFU_PATH" >> .envrc
           echo 'TERRAGRUNT_PROVIDER_CACHE=0' >> .envrc
           direnv allow
       - name: Run Terrateam Action
         id: terrateam
         uses: terrateamio/action@v1
         with:
           work-token: '${{ github.event.inputs.work-token }}'
           api-base-url: '${{ github.event.inputs.api-base-url }}'
         env:
           CUSTOM_CA_BUNDLE_TERRATEAM: ${{ secrets.CUSTOM_CA_CERT }}
           SECRETS_CONTEXT: ${{ toJson(secrets) }}
           VARIABLES_CONTEXT: ${{ toJson(vars) }}
           


